<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Convention">

	<cacheModel id="cacheConvention" type="OSCACHE" readOnly="true">
		<flushInterval hours="12"/>
		<property name="cache-size" value="50"/>
	</cacheModel>

	<typeAlias alias="ClassConvention"
		type="org.esupportail.pstagedata.domain.beans.Convention" />

	<typeAlias alias="ClassConventionExport"
			   type="org.esupportail.pstagedata.domain.beans.ConventionExport" />

	<resultMap id="Convention" class="ClassConvention">
		<result property="idConvention" column="idConvention" />
		<result property="idEtudiant" column="idEtudiant" />
		<result property="idCentreGestion" column="idCentreGestion" />
		<result property="codeUFR" column="codeUFR" />
		<result property="codeUniversiteUFR" column="codeUniversiteUFR" />
		<result property="codeDepartement" column="codeDepartement" />
		<result property="codeEtape" column="codeEtape" />
		<result property="codeVersionEtape" column="codeVersionEtape" />
		<result property="codeUniversiteEtape" column="codeUniversiteEtape" />
		<result property="idEnseignant" column="idEnseignant"
			nullValue="0" />
		<result property="idStructure" column="idStructure" nullValue="0" />
		<result property="idService" column="idService" nullValue="0" />
		<result property="idContact" column="idContact" nullValue="0" />
		<result property="idSignataire" column="idSignataire"
			nullValue="0" />
		<result property="idTypeConvention" column="idTypeConvention" />
		<result property="idOffre" column="idOffre" nullValue="0" />
		<result property="sujetStage" column="sujetStage" />
		<result property="dateDebutStage" column="dateDebutStage" />
		<result property="dateFinStage" column="dateFinStage" />
		<result property="interruptionStage" column="interruptionStage" />
		<result property="dateDebutInterruption" column="dateDebutInterruption" />
		<result property="dateFinInterruption" column="dateFinInterruption" />
		<result property="nbJoursHebdo" column="nbJoursHebdo" />
		<result property="idTempsTravail" column="idTempsTravail" />
		<result property="commentaireDureeTravail" column="commentaireDureeTravail" />
		<result property="codeLangueConvention" column="codeLangueConvention" />
		<result property="idOrigineStage" column="idOrigineStage"
			nullValue="0" />
		<result property="idTheme" column="idTheme" />
		<result property="conventionStructure" column="conventionStructure" />
		<result property="validationConvention" column="validationConvention" />
		<result property="conversionEnContrat" column="conversionEnContrat" />
		<result property="commentaireStage" column="commentaireStage" />
		<result property="adresseEtudiant" column="adresseEtudiant" />
		<result property="codePostalEtudiant" column="codePostalEtudiant" />
		<result property="villeEtudiant" column="villeEtudiant" />
		<result property="paysEtudiant" column="paysEtudiant" />
		<result property="courrielPersoEtudiant" column="courrielPersoEtudiant" />
		<result property="telEtudiant" column="telEtudiant" />
		<result property="telPortableEtudiant" column="telPortableEtudiant" />
		<result property="idIndemnisation" column="idIndemnisation" />
		<result property="montantGratification" column="montantGratification" />
		<result property="fonctionsEtTaches" column="fonctionsEtTaches" />
		<result property="details" column="details" />
		<result property="annee" column="annee" />
		<result property="idAssurance" column="idAssurance" />
		<result property="insee" column="insee" />
		<result property="codeCaisse" column="codeCaisse" />
		<result property="temConfSujetTeme" column="temConfSujetTeme" />
		<result property="nbHeuresHebdo" column="nbHeuresHebdo" />
		<result property="quotiteTravail" column="quotiteTravail" />
		<result property="modeEncadreSuivi" column="modeEncadreSuivi" />
		<result property="idModeVersGratification" column="idModeVersGratification" />
		<result property="avantagesNature" column="avantagesNature" />
		<result property="idNatureTravail" column="idNatureTravail" />
		<result property="idModeValidationStage" column="idModeValidationStage" />
		<result property="codeElp" column="codeElp" />
		<result property="libelleELP" column="libelleELP" />
		<result property="creditECTS" column="creditECTS" />
		<result property="travailNuitFerie" column="travailNuitFerie" />
		<result property="dureeStage" column="dureeStage" />
		<result property="nomEtabRef" column="nomEtabRef" />
		<result property="adresseEtabRef" column="adresseEtabRef" />
		<result property="nomSignataireComposante" column="nomSignataireComposante" />
		<result property="qualiteSignataire" column="qualiteSignataire" />
		<result property="libelleCPAM" column="libelleCPAM" />
		<result property="dureeExceptionnelle" column="dureeExceptionnelle" />
		<result property="idUniteDureeExceptionnelle" column="idUniteDureeExceptionnelle"
			nullValue="0" />
		<result property="idUniteGratification" column="idUniteGratification"
			nullValue="0" />
		<result property="codeFinalite" column="codeFinalite" />
		<result property="libelleFinalite" column="libelleFinalite" />
		<result property="codeCursusLMD" column="codeCursusLMD" />
		<result property="priseEnChargeFraisMission" column="priseEnChargeFraisMission" />
		<result property="codeRGI" column="codeRGI" />
		<result property="loginCreation" column="loginCreation" />
		<result property="dateCreation" column="dateCreation" javaType="java.util.Date"
			jdbcType="DATETIME" />
		<result property="loginModif" column="loginModif" />
		<result property="dateModif" column="dateModif" javaType="java.util.Date"
			jdbcType="DATETIME" />
		<result property="loginValidation" column="loginValidation" />
		<result property="dateValidation" column="dateValidation"
			javaType="java.util.Date" jdbcType="DATETIME" />
		<result property="loginSignature" column="loginSignature" />
		<result property="dateSignature" column="dateSignature"
			javaType="java.util.Date" jdbcType="DATETIME" />
		<result property="validationPedagogique" column="validationPedagogique" />
		<result property="envoiMailEtudiant" column="envoiMailEtudiant" />
		<result property="dateEnvoiMailEtudiant" column="dateEnvoiMailEtudiant"
			javaType="java.util.Date" jdbcType="DATETIME" />
		<result property="envoiMailTuteurPedago" column="envoiMailTuteurPedago" />
		<result property="dateEnvoiMailTuteurPedago" column="dateEnvoiMailTuteurPedago"
			javaType="java.util.Date" jdbcType="DATETIME" />
		<result property="envoiMailTuteurPro" column="envoiMailTuteurPro" />
		<result property="dateEnvoiMailTuteurPro" column="dateEnvoiMailTuteurPro"
			javaType="java.util.Date" jdbcType="DATETIME" />
		<result property="nbConges" column="nbConges"/>
		<result property="competences" column="competences"/>
		
		<result property="idUniteDureeGratification" column="idUniteDureeGratification"
			nullValue="0" />
		<result property="monnaieGratification" column="monnaieGratification" nullValue="euros"/>
	</resultMap>

	<resultMap id="ConventionLight" class="ClassConvention">
		<result property="idConvention" column="idConvention" />
		<result property="dateDebutStage" column="dateDebutStage" />
		<result property="dateFinStage" column="dateFinStage" />
		<result property="validationPedagogique" column="validationPedagogique" />
		<result property="validationConvention" column="validationConvention" />
		<result property="annee" column="annee" />
		<result property="codeUFR" column="codeUFR" />
		<result property="codeEtape" column="codeEtape" />
		<result property="codeVersionEtape" column="codeVersionEtape" />
		<result property="codeUniversiteUFR" column="codeUniversiteUFR" />
		<result property="codeUniversiteEtape" column="codeUniversiteEtape" />
		<result property="idCentreGestion" column="idCentreGestion" />
		<result property="envoiMailEtudiant" column="envoiMailEtudiant" />
		<result property="dateEnvoiMailEtudiant" column="dateEnvoiMailEtudiant"
			javaType="java.util.Date" jdbcType="DATETIME" />
		<result property="envoiMailTuteurPedago" column="envoiMailTuteurPedago" />
		<result property="dateEnvoiMailTuteurPedago" column="dateEnvoiMailTuteurPedago"
			javaType="java.util.Date" jdbcType="DATETIME" />
		<result property="envoiMailTuteurPro" column="envoiMailTuteurPro" />
		<result property="dateEnvoiMailTuteurPro" column="dateEnvoiMailTuteurPro"
			javaType="java.util.Date" jdbcType="DATETIME" />

		<result property="structure" column="idStructure" select="getStructureSuperLightFromId" />
		<result property="etudiant" column="idEtudiant" select="getEtudiantLightFromId" />
		<result property="nbAvenant" column="idConvention" select="getNombreAvenant" />
	</resultMap>

	<resultMap id="ConventionSuperLight" class="ClassConvention">
		<result property="idConvention" column="idConvention" />
	</resultMap>

	<resultMap id="ConventionExport" class="ClassConventionExport">
		<result property="idConvention" column="idConvention" />
		<result property="dateDebutStage" column="dateDebutStage" />
		<result property="dateFinStage" column="dateFinStage" />
		<result property="validationConvention" column="validationConvention" />
		<result property="validationPedagogique" column="validationPedagogique" />
		<result property="interruptionStage" column="interruptionStage" />
		<result property="dateDebutInterruption" column="dateDebutInterruption" />
		<result property="dateFinInterruption" column="dateFinInterruption" />
		<result property="nbJoursHebdo" column="nbJoursHebdo" />
		<result property="idTempsTravail" column="idTempsTravail" />
		<result property="dureeStage" column="dureeStage" />
		<result property="sujetStage" column="sujetStage" />
		<result property="fonctionsEtTaches" column="fonctionsEtTaches" />
		<result property="details" column="details" />
		<result property="idTheme" column="idTheme" />
		<result property="adresseEtudiant" column="adresseEtudiant" />
		<result property="codePostalEtudiant" column="codePostalEtudiant" />
		<result property="villeEtudiant" column="villeEtudiant" />
		<result property="paysEtudiant" column="paysEtudiant" />
		<result property="courrielPersoEtudiant" column="courrielPersoEtudiant" />
		<result property="telEtudiant" column="telEtudiant" />
		<result property="telPortableEtudiant" column="telPortableEtudiant" />
		<result property="montantGratification" column="montantGratification" />
		<result property="idUniteGratification" column="idUniteGratification" />
		<result property="codeDepartement" column="codeDepartement" />
		<result property="dureeExceptionnelle" column="dureeExceptionnelle" />
		<result property="idUniteDureeExceptionnelle" column="idUniteDureeExceptionnelle" />
		<result property="annee" column="annee" />
		<result property="idTypeConvention" column="idTypeConvention" />
		<result property="codeUFR" column="codeUFR" />
		<result property="codeEtape" column="codeEtape" />
		<result property="libelleEtape" column="libelleEtape" />
		<result property="codeVersionEtape" column="codeVersionEtape" />
		<result property="libelleUFR" column="libelleUFR" />
		<result property="codeUniversiteUFR" column="codeUniversiteUFR" />
		<result property="codeUniversiteEtape" column="codeUniversiteEtape" />
		<result property="commentaireStage" column="commentaireStage" />
		<result property="commentaireDureeTravail" column="commentaireDureeTravail" />
		<result property="idIndemnisation" column="idIndemnisation" />
		<result property="codeElp" column="codeElp" />
		<result property="libelleELP" column="libelleELP" />
		<result property="avantagesNature" column="avantagesNature" />
		<result property="dateCreation" column="dateCreation" javaType="java.util.Date"
				jdbcType="DATETIME" />
		<result property="dateModif" column="dateModif" javaType="java.util.Date"
				jdbcType="DATETIME" />
		<result property="idUniteDureeGratification" column="idUniteDureeGratification"/>
		<result property="monnaieGratification" column="monnaieGratification" />

		<result property="STRUCTURE_idStructure" column="idStructure" />
		<result property="STRUCTURE_raisonSociale" column="raisonSociale" />
		<result property="STRUCTURE_numeroSiret" column="numeroSiret" />
		<result property="STRUCTURE_idEffectif" column="idEffectif" />
		<result property="STRUCTURE_idTypeStructure" column="idTypeStructure" />
		<result property="STRUCTURE_idStatutJuridique" column="idStatutJuridique" nullValue="0"/>
		<result property="STRUCTURE_codeNAF_N5" column="codeNAF_N5" />
		<result property="STRUCTURE_telephone" column="structure_telephone" />
		<result property="STRUCTURE_fax" column="fax" />
		<result property="STRUCTURE_mail" column="structure_mail" />
		<result property="STRUCTURE_siteWeb" column="siteWeb" />
		<result property="STRUCTURE_batimentResidence" column="structure_batimentResidence" />
		<result property="STRUCTURE_voie" column="structure_voie" />
		<result property="STRUCTURE_commune" column="structure_commune" />
		<result property="STRUCTURE_codePostal" column="structure_codePostal" />
		<result property="STRUCTURE_libCedex" column="libCedex" />
		<result property="STRUCTURE_idPays" column="structure_idPays" />

		<result property="ETUDIANT_numEtudiant" column="numEtudiant"/>
		<result property="ETUDIANT_codeSexe" column="codeSexe"/>
		<result property="ETUDIANT_id" column="idEtudiant" />
		<result property="ETUDIANT_nom" column="etudiant_nom"/>
		<result property="ETUDIANT_prenom" column="etudiant_prenom"/>
		<result property="ETUDIANT_mail" column="etudiant_mail"/>

		<result property="SERVICE_idService" column="service_idService" />
		<result property="SERVICE_nom" column="service_nom" />
		<result property="SERVICE_telephone" column="service_telephone" />
		<result property="SERVICE_batimentResidence" column="service_batimentResidence" />
		<result property="SERVICE_voie" column="service_voie" />
		<result property="SERVICE_commune" column="service_commune" />
		<result property="SERVICE_codeCommune" column="codeCommune" />
		<result property="SERVICE_codePostal" column="service_codePostal" />
		<result property="SERVICE_idPays" column="service_idPays" />

		<result property="ENSEIGNANT_uidEnseignant" column="uidEnseignant" />
		<result property="ENSEIGNANT_id" column="idEnseignant" />
		<result property="ENSEIGNANT_nom" column="enseignant_nom" />
		<result property="ENSEIGNANT_prenom" column="enseignant_prenom" />
		<result property="ENSEIGNANT_mail" column="enseignant_mail" />
		<result property="ENSEIGNANT_tel" column="enseignant_telephone" />

		<result property="CONTACT_fonction" column="contact_fonction" />
		<result property="CONTACT_idService" column="contact_idService" />
		<result property="CONTACT_idCentreGestion" column="contact_idCentreGestion" />
		<result property="CONTACT_id" column="contact_idContact" />
		<result property="CONTACT_idCivilite" column="contact_idCivilite" />
		<result property="CONTACT_nom" column="contact_nom" />
		<result property="CONTACT_prenom" column="contact_prenom" />
		<result property="CONTACT_mail" column="contact_mail" />
		<result property="CONTACT_tel" column="contact_tel" />

		<result property="SIGNATAIRE_fonction" column="signataire_fonction" />
		<result property="SIGNATAIRE_idService" column="signataire_idService" />
		<result property="SIGNATAIRE_idCentreGestion" column="signataire_idCentreGestion" />
		<result property="SIGNATAIRE_id" column="signataire_idContact" />
		<result property="SIGNATAIRE_idCivilite" column="signataire_idCivilite" />
		<result property="SIGNATAIRE_nom" column="signataire_nom" />
		<result property="SIGNATAIRE_prenom" column="signataire_prenom" />
		<result property="SIGNATAIRE_mail" column="signataire_mail" />
		<result property="SIGNATAIRE_tel" column="signataire_tel" />

		<result property="nbAvenant" column="nbAvenant" />
	</resultMap>

	<statement id="getConventions" resultMap="Convention" cacheModel="cacheConvention">
		SELECT DISTINCT * FROM Convention C
		INNER JOIN CentreGestion CG ON
		C.idCentreGestion = CG.idCentreGestion
		<dynamic prepend="WHERE">
			<isNotNull property="codeUniversite">
				CG.codeUniversite = #codeUniversite#
			</isNotNull>
		</dynamic>
	</statement>

	<statement id="getConventionFromId" resultMap="Convention" cacheModel="cacheConvention">
		SELECT * FROM Convention WHERE idConvention=#idConvention#
		LIMIT 0,1
	</statement>

	<statement id="getConventionsEtudiant" resultMap="ConventionLight" cacheModel="cacheConvention">
		SELECT DISTINCT C.idConvention, C.dateDebutStage, C.dateFinStage,
		C.validationPedagogique,
		C.validationConvention, C.idStructure, C.idEtudiant, C.codeUfr, C.codeEtape,
		C.codeVersionEtape, C.annee,
		C.codeUniversiteUFR, C.codeUniversiteEtape,C.idCentreGestion,
		C.envoiMailEtudiant, C.dateEnvoiMailEtudiant, C.envoiMailTuteurPedago,
		C.dateEnvoiMailTuteurPedago, C.envoiMailTuteurPro,
		C.dateEnvoiMailTuteurPro
		FROM Convention C
		INNER JOIN Etudiant ET ON C.idEtudiant = ET.idEtudiant
		INNER JOIN Ufr U ON (U.codeUFR = C.codeUFR AND U.codeUniversite =
		C.codeUniversiteUFR)
		INNER JOIN Etape E ON (E.codeEtape = C.codeEtape AND E.codeUniversite =
		C.codeUniversiteEtape AND 
		((C.codeVersionEtape != '' AND E.codeVersionEtape != '' AND E.codeVersionEtape = C.codeVersionEtape)
		OR (C.codeVersionEtape != '' AND E.codeVersionEtape = '')
		OR (C.codeVersionEtape = '' AND E.codeVersionEtape != '')
		OR (C.codeVersionEtape = '' AND E.codeVersionEtape = '')))
		LEFT OUTER JOIN Enseignant ES ON C.idEnseignant = ES.idEnseignant
		WHERE ET.identEtudiant = #identEtudiant#
		<isNotNull property="codeUniversite" prepend="AND">
			ET.codeUniversite = #codeUniversite#
		</isNotNull>
		ORDER BY C.dateCreation DESC
	</statement>

	<statement id="getConventionsByEnseignant" resultMap="ConventionLight" cacheModel="cacheConvention">
		SELECT DISTINCT C.idConvention, C.dateDebutStage, C.dateFinStage,
		C.validationPedagogique,
		C.validationConvention, C.idStructure, C.idEtudiant, C.codeUfr, C.codeEtape, C.codeVersionEtape, C.annee,
		C.codeUniversiteUFR, C.codeUniversiteEtape,C.idCentreGestion,
		C.envoiMailEtudiant, C.dateEnvoiMailEtudiant, C.envoiMailTuteurPedago,
		C.dateEnvoiMailTuteurPedago, C.envoiMailTuteurPro,
		C.dateEnvoiMailTuteurPro
		FROM Convention C
		INNER JOIN Etudiant ET ON C.idEtudiant = ET.idEtudiant
		INNER JOIN Ufr U ON (U.codeUFR = C.codeUFR AND U.codeUniversite =
		C.codeUniversiteUFR)
		INNER JOIN Etape E ON (E.codeEtape = C.codeEtape AND E.codeUniversite =
		C.codeUniversiteEtape AND 
		((C.codeVersionEtape != '' AND E.codeVersionEtape != '' AND E.codeVersionEtape = C.codeVersionEtape)
		OR (C.codeVersionEtape != '' AND E.codeVersionEtape = '')
		OR (C.codeVersionEtape = '' AND E.codeVersionEtape != '')
		OR (C.codeVersionEtape = '' AND E.codeVersionEtape = '')))
		INNER JOIN Enseignant ES ON C.idEnseignant = ES.idEnseignant
		LEFT JOIN Avenant AV ON (AV.idConvention = C.idConvention and AV.validationAvenant = true)
		WHERE (ES.idEnseignant=#idEnseignant# OR AV.idEnseignant=#idEnseignant#) and C.annee LIKE CONCAT('%',#annee#,'%')
		ORDER BY C.dateCreation DESC
	</statement>

	<statement id="getAnneesConvention" resultClass="java.lang.String" cacheModel="cacheConvention">
		SELECT DISTINCT C.annee FROM Convention C
		INNER JOIN CentreGestion CG ON C.idCentreGestion = CG.idCentreGestion
		<dynamic prepend="WHERE">
			<isNotNull property="codeUniversite">
				CG.codeUniversite = #codeUniversite#
			</isNotNull>
		</dynamic>
		ORDER BY C.annee DESC
	</statement>

	<statement id="getConventionsFromCriteres" resultMap="ConventionLight" cacheModel="cacheConvention">
		SELECT DISTINCT C.idConvention, C.dateDebutStage, C.dateFinStage,
		C.validationPedagogique,
		C.validationConvention, C.idStructure, C.idEtudiant, C.codeUfr, C.codeEtape,
		C.codeVersionEtape, C.annee,
		C.codeUniversiteUFR, C.codeUniversiteEtape,C.idCentreGestion,
		C.envoiMailEtudiant, C.dateEnvoiMailEtudiant, C.envoiMailTuteurPedago,
		C.dateEnvoiMailTuteurPedago, C.envoiMailTuteurPro,
		C.dateEnvoiMailTuteurPro
		FROM Convention C
		INNER JOIN Ufr U ON (U.codeUFR = C.codeUFR AND
		U.codeUniversite = C.codeUniversiteUFR)
		INNER JOIN Etape E ON (E.codeEtape = C.codeEtape AND E.codeUniversite =
		C.codeUniversiteEtape AND 
		((C.codeVersionEtape != '' AND E.codeVersionEtape != '' AND E.codeVersionEtape = C.codeVersionEtape)
		OR (C.codeVersionEtape != '' AND E.codeVersionEtape = '')
		OR (C.codeVersionEtape = '' AND E.codeVersionEtape != '')
		OR (C.codeVersionEtape = '' AND E.codeVersionEtape = '')))
		INNER JOIN Etudiant ET ON C.idEtudiant = ET.idEtudiant
		LEFT OUTER JOIN Enseignant ES ON C.idEnseignant = ES.idEnseignant
		INNER JOIN CentreGestion CT ON C.idCentreGestion = CT.idCentreGestion
		<isNull property="idC">
			<isNotNull property="idTC">
				INNER JOIN TypeConvention TC ON C.idTypeConvention = TC.idTypeConvention
			</isNotNull>
			<isNotNull property="idTH">
				INNER JOIN Theme TH ON C.idTheme = TH.idTheme
			</isNotNull>
			<isNotNull property="idI">
				INNER JOIN Indemnisation I ON C.idIndemnisation = I.idIndemnisation
			</isNotNull>
			<isNotNull property="idTT">
				INNER JOIN TempsTravail TT ON C.idTempsTravail = TT.idTempsTravail
			</isNotNull>
			<isNotNull property="idLC">
				INNER JOIN LangueConvention LC ON C.codeLangueConvention =
				LC.codeLangueConvention
			</isNotNull>
			<isNotNull property="idO">
				INNER JOIN Offre O ON C.idOffre = O.idOffre
			</isNotNull>
			INNER JOIN Structure S ON S.idStructure = C.idStructure
			<isNotNull property="idPE">
				INNER JOIN Pays P ON (S.idPays = P.idPays AND P.idPays!=82)
			</isNotNull>
			<isNotNull property="idP">
				INNER JOIN Pays P ON S.idPays = P.idPays
			</isNotNull>
			<isNotNull property="idTS">
				INNER JOIN TypeStructure TS ON S.idTypeStructure =
				TS.idTypeStructure
				<isNotNull property="idSJ">
					INNER JOIN StatutJuridique SJ ON
					S.idStatutJuridique = SJ.idStatutJuridique
				</isNotNull>
			</isNotNull>
			<isNotNull property="idEF">
				INNER JOIN Effectif E ON S.idEffectif =
				E.idEffectif
			</isNotNull>
			<isNotNull property="nafN1">
				INNER JOIN NAF_N5 N5 ON N5.codeNAF_N5 =
				S.codeNAF_N5
				INNER JOIN NAF_N1 N1 ON N1.codeNAF_N1 = N5.codeNAF_N1
			</isNotNull>
		</isNull>
		<dynamic prepend="WHERE">
			<isNotNull property="idsCG">
				<iterate prepend="AND" property="idsCG" conjunction="OR"
					open="(" close=")">
					C.idCentreGestion = #idsCG[]#
				</iterate>
			</isNotNull>
			<isNotNull prepend="AND" property="idC">
				C.idConvention = #idC#
			</isNotNull>
			<isNull property="idC">
				<isNotEmpty prepend="AND" property="numET">
					ET.numEtudiant LIKE
					CONCAT('%',#numET#,'%')
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="nET">
					ET.nom LIKE
					CONCAT('%',#nET#,'%')
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="pET">
					ET.prenom LIKE
					CONCAT('%',#pET#,'%')
				</isNotEmpty>
				<isNotNull property="idsUfrs">
					<iterate prepend="AND" property="idsUfrs" conjunction="OR"
						open="(" close=")">
						C.codeUfr = #idsUfrs[]#
					</iterate>
				</isNotNull>
				<isNotNull property="idsEtapes">
					<iterate prepend="AND" property="idsEtapes" conjunction="OR"
						open="(" close=")">
						C.codeEtape = #idsEtapes[]#
					</iterate>
				</isNotNull>
				<isNotEmpty prepend="AND" property="sC">
					C.sujetStage LIKE
					CONCAT('%',#sC#,'%')
				</isNotEmpty>
				<isNotNull prepend="AND" property="idTC">
					C.idTypeConvention =
					#idTC#
				</isNotNull>
				<isNotNull prepend="AND" property="idTH">
					C.idTheme = #idTH#
				</isNotNull>
				<isNotNull prepend="AND" property="nbJH">
					C.nbJoursHebdo = #nbJH#
				</isNotNull>
				<isNotNull prepend="AND" property="idI">
					C.idIndemnisation =
					#idI#
				</isNotNull>
				<isNotNull prepend="AND" property="idTT">
					C.idTempsTravail =
					#idTT#
				</isNotNull>
				<isNotNull prepend="AND" property="idLC">
					C.codeLangueConvention =
					#idLC#
				</isNotNull>
				<isNotNull prepend="AND" property="cVerif">
					C.validationPedagogique
					= #cVerif#
				</isNotNull>
				<isNotNull prepend="AND" property="cV">
					C.validationConvention =
					#cV#
				</isNotNull>
				<isNotNull property="dS">
					<isEqual prepend="AND" property="dS" compareValue="1">
					    (CURDATE() BETWEEN C.dateDebutStage AND C.dateFinStage)
					</isEqual>
					<isEqual prepend="AND" property="dS" compareValue="2">
						C.dateFinStage <![CDATA[ > ]]> CURDATE()
					</isEqual>
					<isEqual prepend="AND" property="dS" compareValue="3">
						(C.dateDebutStage <![CDATA[ >= ]]>
						( CURDATE( ))
						AND C.dateDebutStage <![CDATA[ <= ]]>
						( CURDATE( )+7 ))
					</isEqual>
					<isEqual prepend="AND" property="dS" compareValue="4">
						(C.dateDebutStage <![CDATA[ >= ]]>
						( CURDATE( ))
						AND C.dateDebutStage <![CDATA[ <= ]]>
						( CURDATE( )+15 ))
					</isEqual>
					<isEqual prepend="AND" property="dS" compareValue="5">
						(C.dateDebutStage <![CDATA[ >= ]]>
						( CURDATE( ))
						AND C.dateDebutStage <![CDATA[ <= ]]>
						( CURDATE( )+31 ))
					</isEqual>
				</isNotNull>
				<isNotNull prepend="AND" property="aU">
					C.annee LIKE
					CONCAT('%',#aU#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="idO">
					C.idOffre = #idO#
				</isNotNull>
				<isNotEmpty prepend="AND" property="nE">
					ES.nom LIKE
					CONCAT('%',#nE#,'%')
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="pE">
					ES.prenom LIKE
					CONCAT('%',#pE#,'%')
				</isNotEmpty>
				<isNotNull property="idsUfrs">
					<iterate prepend="AND" property="idsUfrs" conjunction="OR"
						open="(" close=")">
						C.codeUfr = #idsUfrs[]#
					</iterate>
				</isNotNull>
				<isNotNull property="idsEtapes">
					<iterate prepend="AND" property="idsEtapes" conjunction="OR"
						open="(" close=")">
						C.codeEtape = #idsEtapes[]#
					</iterate>
				</isNotNull>
				<isNotEmpty prepend="AND" property="rsS">
					S.raisonSociale LIKE
					CONCAT('%',#rsS#,'%')
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="nsS">
					S.numeroSiret LIKE
					CONCAT('%',#nsS#,'%')
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="cmS">
					S.commune LIKE
					CONCAT('%',#cmS#,'%')
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="cpS">
					S.codePostal LIKE
					CONCAT('%',#cpS#,'%')
				</isNotEmpty>
				<isNotNull prepend="AND" property="idP">
					S.idPays = #idP#
				</isNotNull>
				<isNotNull prepend="AND" property="idTS">
					S.idTypeStructure = #idTS#
					<isNotNull prepend="AND" property="idSJ">
						S.idStatutJuridique =
						#idSJ#
					</isNotNull>
				</isNotNull>
				<isNotNull prepend="AND" property="idE">
					S.idEffectif = #idE#
				</isNotNull>
				<isNotNull prepend="AND" property="nafN1">
					N1.codeNAF_N1 = #nafN1#
				</isNotNull>
			</isNull>
		</dynamic>
		ORDER BY C.dateCreation DESC
		<isNotNull property="isLimit">
			<isEqual property="isLimit" compareValue="1">
				LIMIT 0,#nbRechercheMaxi#
			</isEqual>
		</isNotNull>
	</statement>

	<statement id="getConventionsFromCriteresByEnseignantTuteur"
		resultMap="ConventionLight" cacheModel="cacheConvention">
		SELECT DISTINCT C.idConvention, C.dateDebutStage, C.dateFinStage,
		C.validationPedagogique,
		C.validationConvention, C.idStructure, C.idEtudiant, C.codeUfr, C.codeEtape, C.codeVersionEtape, C.annee,
		C.codeUniversiteUFR, C.codeUniversiteEtape,C.idCentreGestion,
		C.envoiMailEtudiant, C.dateEnvoiMailEtudiant, C.envoiMailTuteurPedago,
		C.dateEnvoiMailTuteurPedago, C.envoiMailTuteurPro,
		C.dateEnvoiMailTuteurPro
		FROM Convention C
		INNER JOIN Ufr U ON (U.codeUFR = C.codeUFR AND
		U.codeUniversite = C.codeUniversiteUFR)
		INNER JOIN Etape E ON (E.codeEtape = C.codeEtape AND E.codeUniversite =
		C.codeUniversiteEtape AND 
		((C.codeVersionEtape != '' AND E.codeVersionEtape != '' AND E.codeVersionEtape = C.codeVersionEtape)
		OR (C.codeVersionEtape != '' AND E.codeVersionEtape = '')
		OR (C.codeVersionEtape = '' AND E.codeVersionEtape != '')
		OR (C.codeVersionEtape = '' AND E.codeVersionEtape = '')))
		INNER JOIN Etudiant ET ON C.idEtudiant = ET.idEtudiant
		LEFT OUTER JOIN Enseignant ES ON C.idEnseignant = ES.idEnseignant
		<isNull property="idC">
			<isNotNull property="idTC">
				INNER JOIN TypeConvention TC ON C.idTypeConvention = TC.idTypeConvention
			</isNotNull>
			<isNotNull property="idTH">
				INNER JOIN Theme TH ON C.idTheme = TH.idTheme
			</isNotNull>
			<isNotNull property="idI">
				INNER JOIN Indemnisation I ON C.idIndemnisation = I.idIndemnisation
			</isNotNull>
			<isNotNull property="idTT">
				INNER JOIN TempsTravail TT ON C.idTempsTravail = TT.idTempsTravail
			</isNotNull>
			<isNotNull property="idLC">
				INNER JOIN LangueConvention LC ON C.codeLangueConvention =
				LC.codeLangueConvention
			</isNotNull>
			<isNotNull property="idO">
				INNER JOIN Offre O ON C.idOffre = O.idOffre
			</isNotNull>
			INNER JOIN Structure S ON S.idStructure = C.idStructure
			<isNotNull property="idPE">
				INNER JOIN Pays P ON (S.idPays = P.idPays AND P.idPays!=82)
			</isNotNull>
			<isNotNull property="idP">
				INNER JOIN Pays P ON S.idPays = P.idPays
			</isNotNull>
			<isNotNull property="idTS">
				INNER JOIN TypeStructure TS ON S.idTypeStructure =
				TS.idTypeStructure
				<isNotNull property="idSJ">
					INNER JOIN StatutJuridique SJ ON
					S.idStatutJuridique = SJ.idStatutJuridique
				</isNotNull>
			</isNotNull>
			<isNotNull property="idEF">
				INNER JOIN Effectif E ON S.idEffectif =
				E.idEffectif
			</isNotNull>
			<isNotNull property="nafN1">
				INNER JOIN NAF_N5 N5 ON N5.codeNAF_N5 =
				S.codeNAF_N5
				INNER JOIN NAF_N1 N1 ON N1.codeNAF_N1 = N5.codeNAF_N1
			</isNotNull>
		</isNull>
		<dynamic prepend="WHERE">
			<isNotNull prepend="AND" property="idEnseignant">
				ES.idEnseignant =
				#idEnseignant#
			</isNotNull>
			<isNotNull prepend="AND" property="idC">
				C.idConvention = #idC#
			</isNotNull>
			<isNull property="idC">
				<isNotNull prepend="AND" property="numET">
					ET.numEtudiant LIKE
					CONCAT('%',#numET#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="nET">
					ET.nom LIKE
					CONCAT('%',#nET#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="pET">
					ET.prenom LIKE
					CONCAT('%',#pET#,'%')
				</isNotNull>
				<isNotNull property="idsUfrs">
					<iterate prepend="AND" property="idsUfrs" conjunction="OR"
						open="(" close=")">
						C.codeUfr = #idsUfrs[]#
					</iterate>
				</isNotNull>
				<isNotNull property="idsEtapes">
					<iterate prepend="AND" property="idsEtapes" conjunction="OR"
						open="(" close=")">
						C.codeEtape = #idsEtapes[]#
					</iterate>
				</isNotNull>
				<isNotNull prepend="AND" property="sC">
					C.sujetStage LIKE
					CONCAT('%',#sC#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="idTC">
					C.idTypeConvention =
					#idTC#
				</isNotNull>
				<isNotNull prepend="AND" property="idTH">
					C.idTheme = #idTH#
				</isNotNull>
				<isNotNull prepend="AND" property="nbJH">
					C.nbJoursHebdo = #nbJH#
				</isNotNull>
				<isNotNull prepend="AND" property="idI">
					C.idIndemnisation =
					#idI#
				</isNotNull>
				<isNotNull prepend="AND" property="idTT">
					C.idTempsTravail =
					#idTT#
				</isNotNull>
				<isNotNull prepend="AND" property="idLC">
					C.codeLangueConvention =
					#idLC#
				</isNotNull>
				<isNotNull prepend="AND" property="cVerif">
					C.validationPedagogique
					= #cVerif#
				</isNotNull>
				<isNotNull prepend="AND" property="cV">
					C.validationConvention =
					#cV#
				</isNotNull>
				<isNotNull property="dS">
					<isEqual prepend="AND" property="dS" compareValue="1">
					    (CURDATE() BETWEEN C.dateDebutStage AND C.dateFinStage)
					</isEqual>
					<isEqual prepend="AND" property="dS" compareValue="2">
						C.dateFinStage <![CDATA[ > ]]>
						CURDATE()
					</isEqual>
					<isEqual prepend="AND" property="dS" compareValue="3">
						(C.dateDebutStage <![CDATA[ >= ]]>
						( CURDATE( ))
						AND C.dateDebutStage <![CDATA[ <= ]]>
						( CURDATE( )+7 ))
					</isEqual>
					<isEqual prepend="AND" property="dS" compareValue="4">
						(C.dateDebutStage <![CDATA[ >= ]]>
						( CURDATE( ))
						AND C.dateDebutStage <![CDATA[ <= ]]>
						( CURDATE( )+15 ))
					</isEqual>
					<isEqual prepend="AND" property="dS" compareValue="5">
						(C.dateDebutStage <![CDATA[ >= ]]>
						( CURDATE( ))
						AND C.dateDebutStage <![CDATA[ <= ]]>
						( CURDATE( )+31 ))
					</isEqual>
				</isNotNull>
				<isNotNull prepend="AND" property="aU">
					C.annee LIKE
					CONCAT('%',#aU#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="idO">
					C.idOffre = #idO#
				</isNotNull>
				<isNotNull prepend="AND" property="nE">
					ES.nom LIKE
					CONCAT('%',#nE#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="pE">
					ES.prenom LIKE
					CONCAT('%',#pE#,'%')
				</isNotNull>
				<isNotNull property="idsUfrs">
					<iterate prepend="AND" property="idsUfrs" conjunction="OR"
						open="(" close=")">
						C.codeUfr = #idsUfrs[]#
					</iterate>
				</isNotNull>
				<isNotNull property="idsEtapes">
					<iterate prepend="AND" property="idsEtapes" conjunction="OR"
						open="(" close=")">
						C.codeEtape = #idsEtapes[]#
					</iterate>
				</isNotNull>
				<isNotNull prepend="AND" property="rsS">
					S.raisonSociale LIKE
					CONCAT('%',#rsS#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="nsS">
					S.numeroSiret LIKE
					CONCAT('%',#nsS#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="cmS">
					S.commune LIKE
					CONCAT('%',#cmS#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="cpS">
					S.codePostal LIKE
					CONCAT('%',#cpS#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="idP">
					S.idPays = #idP#
				</isNotNull>
				<isNotNull prepend="AND" property="idTS">
					S.idTypeStructure = #idTS#
					<isNotNull prepend="AND" property="idSJ">
						S.idStatutJuridique =
						#idSJ#
					</isNotNull>
				</isNotNull>
				<isNotNull prepend="AND" property="idE">
					S.idEffectif = #idE#
				</isNotNull>
				<isNotNull prepend="AND" property="nafN1">
					N1.codeNAF_N1 = #nafN1#
				</isNotNull>
			</isNull>
		</dynamic>
		ORDER BY C.dateCreation DESC
		<isNotNull property="isLimit">
			<isEqual property="isLimit" compareValue="1">
				LIMIT 0,#nbRechercheMaxi#
			</isEqual>
		</isNotNull>
	</statement>

	<statement id="getConventionsFromCriteresExport" resultMap="ConventionSuperLight" cacheModel="cacheConvention">
		SELECT DISTINCT C.idConvention
		FROM Convention C
		INNER JOIN Ufr U ON (U.codeUFR = C.codeUFR AND
		U.codeUniversite = C.codeUniversiteUFR)
		INNER JOIN Etape E ON (E.codeEtape = C.codeEtape AND E.codeUniversite =
		C.codeUniversiteEtape AND 
		((C.codeVersionEtape != '' AND E.codeVersionEtape != '' AND E.codeVersionEtape = C.codeVersionEtape)
		OR (C.codeVersionEtape != '' AND E.codeVersionEtape = '')
		OR (C.codeVersionEtape = '' AND E.codeVersionEtape != '')
		OR (C.codeVersionEtape = '' AND E.codeVersionEtape = '')))
		INNER JOIN Etudiant ET ON C.idEtudiant = ET.idEtudiant
		LEFT OUTER JOIN Enseignant ES ON C.idEnseignant = ES.idEnseignant
		INNER JOIN CentreGestion CT ON C.idCentreGestion = CT.idCentreGestion
		<isNull property="idC">
			<isNotNull property="idTC">
				INNER JOIN TypeConvention TC ON C.idTypeConvention = TC.idTypeConvention
			</isNotNull>
			<isNotNull property="idTH">
				INNER JOIN Theme TH ON C.idTheme = TH.idTheme
			</isNotNull>
			<isNotNull property="idI">
				INNER JOIN Indemnisation I ON C.idIndemnisation = I.idIndemnisation
			</isNotNull>
			<isNotNull property="idTT">
				INNER JOIN TempsTravail TT ON C.idTempsTravail = TT.idTempsTravail
			</isNotNull>
			<isNotNull property="idLC">
				INNER JOIN LangueConvention LC ON C.codeLangueConvention =
				LC.codeLangueConvention
			</isNotNull>
			<isNotNull property="idO">
				INNER JOIN Offre O ON C.idOffre = O.idOffre
			</isNotNull>
			INNER JOIN Structure S ON S.idStructure = C.idStructure
			<isNotNull property="idPE">
				INNER JOIN Pays P ON (S.idPays = P.idPays AND P.idPays!=82)
			</isNotNull>
			<isNotNull property="idP">
				INNER JOIN Pays P ON S.idPays = P.idPays
			</isNotNull>
			<isNotNull property="idTS">
				INNER JOIN TypeStructure TS ON S.idTypeStructure =
				TS.idTypeStructure
				<isNotNull property="idSJ">
					INNER JOIN StatutJuridique SJ ON
					S.idStatutJuridique = SJ.idStatutJuridique
				</isNotNull>
			</isNotNull>
			<isNotNull property="idEF">
				INNER JOIN Effectif E ON S.idEffectif =
				E.idEffectif
			</isNotNull>
			<isNotNull property="nafN1">
				INNER JOIN NAF_N5 N5 ON N5.codeNAF_N5 =
				S.codeNAF_N5
				INNER JOIN NAF_N1 N1 ON N1.codeNAF_N1 = N5.codeNAF_N1
			</isNotNull>
		</isNull>
		<dynamic prepend="WHERE">
			<isNotNull property="idsCG">
				<iterate prepend="AND" property="idsCG" conjunction="OR"
					open="(" close=")">
					C.idCentreGestion = #idsCG[]#
				</iterate>
			</isNotNull>
			<isNotNull prepend="AND" property="idC">
				C.idConvention = #idC#
			</isNotNull>
			<isNull property="idC">
				<isNotNull prepend="AND" property="numET">
					ET.numEtudiant LIKE
					CONCAT('%',#numET#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="nET">
					ET.nom LIKE
					CONCAT('%',#nET#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="pET">
					ET.prenom LIKE
					CONCAT('%',#pET#,'%')
				</isNotNull>
				<isNotNull property="idsUfrs">
					<iterate prepend="AND" property="idsUfrs" conjunction="OR"
						open="(" close=")">
						C.codeUfr = #idsUfrs[]#
					</iterate>
				</isNotNull>
				<isNotNull property="idsEtapes">
					<iterate prepend="AND" property="idsEtapes" conjunction="OR"
						open="(" close=")">
						C.codeEtape = #idsEtapes[]#
					</iterate>
				</isNotNull>
				<isNotNull prepend="AND" property="sC">
					C.sujetStage LIKE
					CONCAT('%',#sC#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="idTC">
					C.idTypeConvention =
					#idTC#
				</isNotNull>
				<isNotNull prepend="AND" property="idTH">
					C.idTheme = #idTH#
				</isNotNull>
				<isNotNull prepend="AND" property="nbJH">
					C.nbJoursHebdo = #nbJH#
				</isNotNull>
				<isNotNull prepend="AND" property="idI">
					C.idIndemnisation =
					#idI#
				</isNotNull>
				<isNotNull prepend="AND" property="idTT">
					C.idTempsTravail =
					#idTT#
				</isNotNull>
				<isNotNull prepend="AND" property="idLC">
					C.codeLangueConvention =
					#idLC#
				</isNotNull>
				<isNotNull prepend="AND" property="cVerif">
					C.validationPedagogique
					= #cVerif#
				</isNotNull>
				<isNotNull prepend="AND" property="cV">
					C.validationConvention =
					#cV#
				</isNotNull>
				<isNotNull property="dS">
					<isEqual prepend="AND" property="dS" compareValue="1">
					    (CURDATE() BETWEEN C.dateDebutStage AND C.dateFinStage)
					</isEqual>
					<isEqual prepend="AND" property="dS" compareValue="2">
						C.dateFinStage <![CDATA[ > ]]>
						CURDATE()
					</isEqual>
					<isEqual prepend="AND" property="dS" compareValue="3">
						(C.dateDebutStage <![CDATA[ >= ]]>
						( CURDATE( ))
						AND C.dateDebutStage <![CDATA[ <= ]]>
						( CURDATE( )+7 ))
					</isEqual>
					<isEqual prepend="AND" property="dS" compareValue="4">
						(C.dateDebutStage <![CDATA[ >= ]]>
						( CURDATE( ))
						AND C.dateDebutStage <![CDATA[ <= ]]>
						( CURDATE( )+15 ))
					</isEqual>
					<isEqual prepend="AND" property="dS" compareValue="5">
						(C.dateDebutStage <![CDATA[ >= ]]>
						( CURDATE( ))
						AND C.dateDebutStage <![CDATA[ <= ]]>
						( CURDATE( )+31 ))
					</isEqual>
				</isNotNull>
				<isNotNull prepend="AND" property="aU">
					C.annee LIKE
					CONCAT('%',#aU#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="idO">
					C.idOffre = #idO#
				</isNotNull>
				<isNotNull prepend="AND" property="nE">
					ES.nom LIKE
					CONCAT('%',#nE#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="pE">
					ES.prenom LIKE
					CONCAT('%',#pE#,'%')
				</isNotNull>
				<isNotNull property="idsUfrs">
					<iterate prepend="AND" property="idsUfrs" conjunction="OR"
						open="(" close=")">
						C.codeUfr = #idsUfrs[]#
					</iterate>
				</isNotNull>
				<isNotNull property="idsEtapes">
					<iterate prepend="AND" property="idsEtapes" conjunction="OR"
						open="(" close=")">
						C.codeEtape = #idsEtapes[]#
					</iterate>
				</isNotNull>
				<isNotNull prepend="AND" property="rsS">
					S.raisonSociale LIKE
					CONCAT('%',#rsS#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="nsS">
					S.numeroSiret LIKE
					CONCAT('%',#nsS#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="cmS">
					S.commune LIKE
					CONCAT('%',#cmS#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="cpS">
					S.codePostal LIKE
					CONCAT('%',#cpS#,'%')
				</isNotNull>
				<isNotNull prepend="AND" property="idP">
					S.idPays = #idP#
				</isNotNull>
				<isNotNull prepend="AND" property="idTS">
					S.idTypeStructure = #idTS#
					<isNotNull prepend="AND" property="idSJ">
						S.idStatutJuridique =
						#idSJ#
					</isNotNull>
				</isNotNull>
				<isNotNull prepend="AND" property="idE">
					S.idEffectif = #idE#
				</isNotNull>
				<isNotNull prepend="AND" property="nafN1">
					N1.codeNAF_N1 = #nafN1#
				</isNotNull>
			</isNull>
		</dynamic>
		<isNotNull property="isLimit">
			<isEqual property="isLimit" compareValue="1">
				LIMIT 0,#nbExportMaxi#
			</isEqual>
		</isNotNull>
	</statement>

	<statement id="getConventionsFromExport" resultMap="ConventionExport" cacheModel="cacheConvention">
		SELECT DISTINCT C.idConvention, C.dateDebutStage, C.dateFinStage,
		C.validationConvention, C.validationPedagogique, C.interruptionStage, C.dateDebutInterruption,
		C.dateFinInterruption,
		C.nbJoursHebdo, C.idTempsTravail, C.dureeStage, C.sujetStage,
		C.fonctionsEtTaches, C.details, C.idTheme,
		C.courrielPersoEtudiant, C.telEtudiant, C.telPortableEtudiant,
		C.montantGratification, C.idUniteGratification,
		C.dureeExceptionnelle, C.idUniteDureeExceptionnelle,
		C.idStructure, C.idEtudiant, C.codeDepartement,
		C.idService, C.idEnseignant, C.idContact, C.annee, C.idSignataire,
		C.idTypeConvention,
		C.codeUFR, C.codeEtape, C.codeVersionEtape, C.codeUniversiteUFR, C.codeUniversiteEtape, C.codeElp,
		C.libelleElp,
		C.commentaireStage, C.commentaireDureeTravail, C.idIndemnisation, C.avantagesNature,
		C.adresseEtudiant, C.codePostalEtudiant, C.villeEtudiant, C.paysEtudiant, C.idUniteDureeGratification,
		C.monnaieGratification, C.dateCreation, C.dateModif,

		S.idStructure,
		S.raisonSociale,
		S.numeroSiret,
		S.batimentResidence AS 'structure_batimentResidence',
		S.voie AS 'structure_voie',
		S.commune AS 'structure_commune',
		S.codePostal AS 'structure_codePostal',
		S.libCedex,
		S.idPays AS 'structure_idPays',
		S.idEffectif,
		S.idTypeStructure,
		S.idStatutJuridique,
		S.codeNAF_N5,
		S.telephone AS 'structure_telephone',
		S.fax,
		S.mail AS 'structure_mail',
		S.siteWeb,

		E.idEtudiant,
		E.nom AS 'etudiant_nom',
		E.prenom AS 'etudiant_prenom',
		E.mail AS 'etudiant_mail',
		E.numEtudiant,
		E.codeSexe,

		SE.idService AS 'service_idService',
		SE.nom AS 'service_nom',
		SE.batimentResidence AS 'service_batimentResidence',
		SE.voie AS 'service_voie',
		SE.commune AS 'service_commune',
		SE.codeCommune,
		SE.codePostal AS 'service_codePostal',
		SE.idPays AS 'service_idPays',
		SE.telephone AS 'service_telephone',

		ENS.idEnseignant,
		ENS.uidEnseignant,
		ENS.nom AS 'enseignant_nom',
		ENS.prenom AS 'enseignant_prenom',
		ENS.mail AS 'enseignant_mail',
		ENS.telephone AS 'enseignant_telephone',

		CO.idContact AS 'contact_idContact',
		CO.idCivilite AS 'contact_idCivilite',
		CO.nom AS 'contact_nom',
		CO.prenom AS 'contact_prenom',
		CO.mail AS 'contact_mail',
		CO.tel AS 'contact_tel',
		CO.fonction AS 'contact_fonction',
		CO.idService AS 'contact_idService',
		CO.idCentreGestion AS 'contact_idCentreGestion',

		SI.idContact AS 'signataire_idContact',
		SI.idCivilite AS 'signataire_idCivilite',
		SI.nom AS 'signataire_nom',
		SI.prenom AS 'signataire_prenom',
		SI.mail AS 'signataire_mail',
		SI.tel AS 'signataire_tel',
		SI.fonction AS 'signataire_fonction',
		SI.idService AS 'signataire_idService',
		SI.idCentreGestion AS 'signataire_idCentreGestion',

		U.libelleUFR,
		ETA.libelleEtape,
		(SELECT COUNT(*) FROM Avenant A
		WHERE A.idConvention = C.idConvention) AS 'nbAvenant'

		FROM Convention C
		LEFT JOIN Structure AS S ON (S.idStructure = C.idStructure)
		LEFT JOIN Etudiant AS E ON (E.idEtudiant = C.idEtudiant)
		LEFT JOIN Service AS SE ON (SE.idService = C.idService)
		LEFT JOIN Enseignant AS ENS ON (ENS.idEnseignant = C.idEnseignant)
		LEFT JOIN Contact AS CO ON (CO.idContact = C.idContact)
		LEFT JOIN Contact AS SI ON (SI.idContact = C.idSignataire)
		LEFT JOIN Ufr AS U ON (U.codeUFR = C.codeUFR AND U.codeUniversite = C.codeUniversiteUFR)
		LEFT JOIN Etape ETA ON (ETA.codeEtape = C.codeEtape AND ETA.codeUniversite = C.codeUniversiteEtape)
		<dynamic prepend="WHERE">
			<isNotNull prepend="AND" property="idsConventionsExport"
				open="(" close=")">
				<iterate property="idsConventionsExport" conjunction="OR">
					C.idConvention = #idsConventionsExport[]#
				</iterate>
			</isNotNull>
		</dynamic>
		AND S.temEnServStructure = 'O'
		GROUP BY C.idConvention
		ORDER BY C.idConvention
	</statement>

	<statement id="getNombreConventionByCentreGestion"
		resultClass="java.lang.Integer" cacheModel="cacheConvention">
		SELECT COUNT(*) FROM Convention C
		INNER JOIN CentreGestion CG ON
		C.idCentreGestion = CG.idCentreGestion
		WHERE CG.idCentreGestion =
		#idCentreGestion#
		<isNotNull property="codeUniversite" prepend="AND">
			CG.codeUniversite = #codeUniversite#
		</isNotNull>
	</statement>

	<insert id="addConvention">
		INSERT INTO Convention
		(idConvention,idEtudiant,idCentreGestion,codeUFR,codeUniversiteUFR,codeDepartement,codeEtape,codeVersionEtape,codeUniversiteEtape,
		idEnseignant,idStructure,idService,idContact,idSignataire,idTypeConvention,idOffre,
		sujetStage,dateDebutStage,dateFinStage,interruptionStage,dateDebutInterruption,dateFinInterruption,
		nbJoursHebdo,idTempsTravail,commentaireDureeTravail,codeLangueConvention,idOrigineStage,idTheme,conventionStructure,validationPedagogique,
		validationConvention,conversionEnContrat,commentaireStage,adresseEtudiant,codePostalEtudiant,villeEtudiant,paysEtudiant,courrielPersoEtudiant,telEtudiant,telPortableEtudiant,
		idIndemnisation,montantGratification,fonctionsEtTaches,details,annee,idAssurance,insee,codeCaisse,temConfSujetTeme,nbHeuresHebdo,quotiteTravail,
		modeEncadreSuivi,idModeVersGratification,avantagesNature,idNatureTravail,idModeValidationStage,codeElp,libelleELP,creditECTS,travailNuitFerie,
		dureeStage,nomEtabRef,adresseEtabRef,nomSignataireComposante,qualiteSignataire,libelleCPAM,dureeExceptionnelle,idUniteDureeExceptionnelle,idUniteGratification,
		codeFinalite,libelleFinalite,codeCursusLMD,priseEnChargeFraisMission,codeRGI,loginCreation,dateCreation,nbConges,competences,idUniteDureeGratification,monnaieGratification)
		VALUES
		(#idConvention#,#idEtudiant#,#idCentreGestion#,#codeUFR#,#codeUniversiteUFR#,#codeDepartement#,#codeEtape#,#codeVersionEtape#,#codeUniversiteEtape#,
		#idEnseignant#,#idStructure#,#idService#,#idContact#,#idSignataire#,#idTypeConvention#,#idOffre#,
		#sujetStage#,#dateDebutStage#,#dateFinStage#,#interruptionStage#,#dateDebutInterruption#,#dateFinInterruption#,
		#nbJoursHebdo#,#idTempsTravail#,#commentaireDureeTravail#,#codeLangueConvention#,#idOrigineStage#,#idTheme#,#conventionStructure#,#validationPedagogique#,
		#validationConvention#,#conversionEnContrat#,#commentaireStage#,#adresseEtudiant#,#codePostalEtudiant#,#villeEtudiant#,#paysEtudiant#,#courrielPersoEtudiant#,#telEtudiant#,#telPortableEtudiant#,
		#idIndemnisation#,#montantGratification#,#fonctionsEtTaches#,#details#,#annee#,#idAssurance#,#insee#,#codeCaisse#,#temConfSujetTeme#,#nbHeuresHebdo#,#quotiteTravail#,
		#modeEncadreSuivi#,#idModeVersGratification#,#avantagesNature#,#idNatureTravail#,#idModeValidationStage#,#codeElp#,#libelleELP#,#creditECTS#,#travailNuitFerie#,
		#dureeStage#,#nomEtabRef#,#adresseEtabRef#,#nomSignataireComposante#,#qualiteSignataire#,#libelleCPAM#,#dureeExceptionnelle#,#idUniteDureeExceptionnelle#,#idUniteGratification#,
		#codeFinalite#,#libelleFinalite#,#codeCursusLMD#,#priseEnChargeFraisMission#,#codeRGI#,#loginCreation#,CURRENT_TIMESTAMP(),#nbConges#,#competences#,#idUniteDureeGratification#,#monnaieGratification#)
		<selectKey resultClass="java.lang.Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>

	<update id="updateConvention">
		UPDATE Convention SET
		idConvention = #idConvention#,idEtudiant = #idEtudiant#,idCentreGestion =
		#idCentreGestion#,codeUFR = #codeUFR#,codeUniversiteUFR =
		#codeUniversiteUFR#,
		codeDepartement = #codeDepartement#,codeEtape = #codeEtape#,codeVersionEtape =
		#codeVersionEtape#, codeUniversiteEtape = #codeUniversiteEtape#,
		idEnseignant = #idEnseignant#,idStructure = #idStructure#,idService =
		#idService#,idContact = #idContact#,idSignataire =
		#idSignataire#,idTypeConvention = #idTypeConvention#,idOffre =
		#idOffre#,
		sujetStage = #sujetStage#,dateDebutStage = #dateDebutStage#,dateFinStage =
		#dateFinStage#,interruptionStage =
		#interruptionStage#,dateDebutInterruption =
		#dateDebutInterruption#,dateFinInterruption = #dateFinInterruption#,
		nbJoursHebdo = #nbJoursHebdo#,idTempsTravail =
		#idTempsTravail#,commentaireDureeTravail = #commentaireDureeTravail#,
		codeLangueConvention = #codeLangueConvention#,idOrigineStage =
		#idOrigineStage#,idTheme = #idTheme#,conventionStructure =
		#conventionStructure#,validationPedagogique=#validationPedagogique#,
		validationConvention = #validationConvention#,conversionEnContrat =
		#conversionEnContrat#,commentaireStage = #commentaireStage#,
		adresseEtudiant = #adresseEtudiant#,codePostalEtudiant =
		#codePostalEtudiant#,villeEtudiant = #villeEtudiant#,
		paysEtudiant = #paysEtudiant#,courrielPersoEtudiant =
		#courrielPersoEtudiant#,telEtudiant =
		#telEtudiant#,telPortableEtudiant = #telPortableEtudiant#,
		idIndemnisation = #idIndemnisation#,montantGratification =
		#montantGratification#,fonctionsEtTaches = #fonctionsEtTaches#,details
		= #details#,annee = #annee#,
		idAssurance = #idAssurance#,insee = #insee#,codeCaisse =
		#codeCaisse#,temConfSujetTeme = #temConfSujetTeme#,nbHeuresHebdo =
		#nbHeuresHebdo#,quotiteTravail = #quotiteTravail#,
		modeEncadreSuivi = #modeEncadreSuivi#,idModeVersGratification =
		#idModeVersGratification#,avantagesNature = #avantagesNature#,
		idNatureTravail = #idNatureTravail#,idModeValidationStage =
		#idModeValidationStage#,codeElp = #codeElp#,libelleELP =
		#libelleELP#,creditECTS = #creditECTS#,travailNuitFerie =
		#travailNuitFerie#,
		dureeStage = #dureeStage#,nomEtabRef = #nomEtabRef#,adresseEtabRef =
		#adresseEtabRef#,nomSignataireComposante = #nomSignataireComposante#,
		qualiteSignataire = #qualiteSignataire#,libelleCPAM =
		#libelleCPAM#,dureeExceptionnelle =
		#dureeExceptionnelle#,idUniteDureeExceptionnelle =
		#idUniteDureeExceptionnelle#,idUniteGratification =
		#idUniteGratification#,
		codeFinalite = #codeFinalite#,libelleFinalite = #libelleFinalite#,codeCursusLMD =
		#codeCursusLMD#,priseEnChargeFraisMission =
		#priseEnChargeFraisMission#,
		codeRGI=#codeRGI#,
		loginModif = #loginModif#,dateModif = CURRENT_TIMESTAMP(),loginValidation =
		#loginValidation#,dateValidation = #dateValidation#,loginSignature =
		#loginSignature#,dateSignature=#dateSignature#,nbConges=#nbConges#,
		competences=#competences#,idUniteDureeGratification=#idUniteDureeGratification#,
		monnaieGratification=#monnaieGratification#
		WHERE idConvention = #idConvention#
	</update>

	<statement id="getCodeUFRFromCodeEtape" resultClass="java.lang.String">
		SELECT DISTINCT C.codeUFR FROM Convention C
		INNER JOIN Ufr U ON (U.codeUFR = C.codeUFR AND U.codeUniversite =
		C.codeUniversiteUFR)
		WHERE C.codeEtape=#codeEtape#
		<isNotNull property="codeUniversite" prepend="AND">
			C.codeUniversiteEtape = #codeUniversite#
		</isNotNull>
		LIMIT 0,1
	</statement>

	<update id="updateCentreConventionByUfr">
		UPDATE Convention C
		INNER JOIN CentreGestion CG ON C.idCentreGestion = CG.idCentreGestion
		SET C.idCentreGestion = #idCentreGestion#
		WHERE C.codeUFR=#code#
		<isNotNull property="codeUniversite" prepend="AND">
			C.codeUniversiteUFR = #codeUniversite#
		</isNotNull>
	</update>

	<update id="updateCentreConventionByEtape">
		UPDATE Convention C
		INNER JOIN CentreGestion CG ON C.idCentreGestion = CG.idCentreGestion
		SET C.idCentreGestion = #idCentreGestion#
		WHERE C.codeEtape=#code#
		<isNotNull property="codeUniversite" prepend="AND">
			C.codeUniversiteEtape = #codeUniversite#
		</isNotNull>
		<isNotNull property="codeVersionEtape" prepend="AND">
			C.codeVersionEtape = #codeVersionEtape#
		</isNotNull>
	</update>

	<delete id="deleteConvention">
		DELETE FROM Convention WHERE idConvention = #idConvention#
	</delete>

	<update id="setEnvoiMailEtudiant">
		UPDATE Convention SET envoiMailEtudiant=true,
		dateEnvoiMailEtudiant=CURRENT_TIMESTAMP()
		WHERE
		idConvention=#idConvention#
	</update>
	<update id="setEnvoiMailEnseignant">
		UPDATE Convention SET envoiMailTuteurPedago=true,
		dateEnvoiMailTuteurPedago=CURRENT_TIMESTAMP()
		WHERE
		idConvention=#idConvention#
	</update>
	<update id="setEnvoiMailEntreprise">
		UPDATE Convention SET envoiMailTuteurPro=true,
		dateEnvoiMailTuteurPro=CURRENT_TIMESTAMP()
		WHERE
		idConvention=#idConvention#
	</update>
	
	<update id="updateConventionSetCodeVersionEtape">
		UPDATE Convention SET codeVersionEtape=#codeVersionEtape#
		WHERE codeEtape = #codeEtape# AND codeVersionEtape = ''
	</update>
	
	<statement id="getNbConventionsByAnneeAndEtu" resultClass="java.lang.Integer">
		SELECT count(*) FROM Convention C
		INNER JOIN Etudiant ET ON C.idEtudiant = ET.idEtudiant
		WHERE C.annee LIKE CONCAT('%',#annee#,'%')
		AND ET.identEtudiant = #identEtudiant#
		<isNotNull property="codeUniversite" prepend="AND">
			ET.codeUniversite = #codeUniversite#
		</isNotNull>
	</statement>
	
	<!-- Ajout pour la methode permettant de remettre les bons centres de gestion
	aux conventions lorsque l'on supprime le rattachement d'un critere ufr -->
	<statement id="getCodesEtapesConventionsFromCodeUfrAndIdCentre"
	    resultClass="java.lang.String">
		SELECT DISTINCT CONCAT(C.codeEtape, IF(C.codeVersionEtape IS NULL OR C.codeVersionEtape = '','',';'), C.codeVersionEtape) FROM Convention C
		WHERE C.codeUfr = #codeUfr# AND C.idCentreGestion = #idCentreGestion#
		<isNotNull property="codeUniversite" prepend="AND">
			C.codeUniversiteEtape = #codeUniversite#
		</isNotNull>
	</statement>
		
	<update id="updateConventionValidation">
		UPDATE Convention SET loginValidation=#loginValidation#,dateValidation=CURRENT_TIMESTAMP(),
		validationConvention=#validationConvention#, validationPedagogique=#validationPedagogique#
		WHERE idConvention=#idConvention#
	</update>
	
</sqlMap>
